<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>イチニチ一歩 - 睡眠帯グラフ</title>
  <style>
    body {
      font-family: "Hiragino Kaku Gothic ProN", sans-serif;
      background-color: #fff8e7;
      text-align: center;
      padding: 20px;
    }
    h1 {
      background-color: orange;
      color: white;
      padding: 10px;
      border-radius: 10px;
    }
    input, button {
      margin: 5px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      cursor: pointer;
      background-color: #f0f0f0;
      border: none;
      border-radius: 8px;
    }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>

<h1>イチニチ一歩（睡眠帯）</h1>

<h3>🕒 睡眠記録</h3>
<label>昨日寝た時間：</label>
<input type="time" id="sleepTime"><br>
<label>今日起きた時間：</label>
<input type="time" id="wakeTime"><br>
<p id="sleepDuration">睡眠時間：--時間</p>
<button onclick="saveData()">保存</button>

<canvas id="sleepChart" width="400" height="300"></canvas>

<!-- Chart.js v4 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
let records = JSON.parse(localStorage.getItem('sleepData') || '[]');
let sleepChart = null;

// 睡眠時間計算
function calcSleepDuration() {
  const sleep = document.getElementById("sleepTime").value;
  const wake = document.getElementById("wakeTime").value;
  if (!sleep || !wake) return null;

  const s = new Date(`1970-01-01T${sleep}:00`);
  let w = new Date(`1970-01-01T${wake}:00`);
  if (w < s) w.setDate(w.getDate() + 1);
  const diffH = ((w - s)/(1000*60*60)).toFixed(1);
  document.getElementById("sleepDuration").textContent = `睡眠時間：${diffH}時間`;
  return diffH;
}

// 時間を数値化（時 + 分/60）
function parseTimeToNumber(timeStr) {
  const [h,m] = timeStr.split(':').map(Number);
  return h + m/60;
}

document.getElementById("sleepTime").addEventListener("change", calcSleepDuration);
document.getElementById("wakeTime").addEventListener("change", calcSleepDuration);

// データ保存
function saveData() {
  const date = new Date().toLocaleDateString();
  const sleepTime = document.getElementById("sleepTime").value;
  const wakeTime = document.getElementById("wakeTime").value;
  const duration = calcSleepDuration();

  if (!duration) { alert("睡眠時間を入力してください"); return; }

  records.push({ date, sleepTime, wakeTime, duration });
  localStorage.setItem('sleepData', JSON.stringify(records));
  updateChart();
}

// ガントチャート風更新
function updateChart() {
  const ctx = document.getElementById("sleepChart");
  if (sleepChart) sleepChart.destroy();

  const labels = records.map(r => r.date);
  const datasets = [{
    label: '睡眠帯',
    data: records.map(r => {
      let start = parseTimeToNumber(r.sleepTime);
      let end = parseTimeToNumber(r.wakeTime);
      if (end < start) end += 24; // 翌日対応
      return { x: start, x2: end, y: r.date }; // Chart.js v4 floating bar
    }),
    backgroundColor: 'rgba(0,128,255,0.5)',
  }];

  sleepChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          min: 0,
          max: 24,
          title: { display: true, text: '時間（時）' },
          ticks: { stepSize: 2 }
        },
        y: { title: { display: true, text: '日付' } }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => {
              const start = ctx.raw.x % 24;
              const end = ctx.raw.x2 % 24;
              return `睡眠 ${Math.floor(start)}:${('0'+Math.round((start%1)*60)).slice(-2)} - ${Math.floor(end)}:${('0'+Math.round((end%1)*60)).slice(-2)}`;
            }
          }
        }
      }
    }
  });
}

updateChart();
</script>

</body>
</html>
