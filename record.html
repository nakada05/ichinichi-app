<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>睡眠を記録する</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff8e7;padding:22px}
    h1{background:orange;color:#fff;padding:12px;border-radius:12px;text-align:center}
    label{display:block;margin-top:12px;font-weight:700}
    input[type="time"], input[type="date"], textarea{width:100%;max-width:320px;padding:8px;border-radius:8px;border:1px solid #bbb;margin-top:6px}
    .btn-row{margin-top:12px}
    .select-btn{margin:6px;padding:8px 14px;border-radius:10px;border:none;background:#f0f0f0;cursor:pointer}
    .active{background:#ffcc80;border:2px solid orange;font-weight:700}
    #saveBtn{margin-top:20px;padding:12px 20px;border-radius:12px;background:orange;color:#fff;border:none;font-size:16px}
    a.back{display:block;margin-top:18px;color:#444;text-decoration:none}
  </style>
</head>
<body>
  <h1>睡眠を記録する</h1>

  <label>日付</label>
  <input type="date" id="dateInput">

  <label>寝た時間（昨夜）</label>
  <input type="time" id="sleepTime">

  <label>起きた時間（今朝）</label>
  <input type="time" id="wakeTime">

  <p id="sleepDuration">睡眠時間：--時間</p>

  <label>睡眠前の行動</label>
  <div id="actionButtons">
    <button class="select-btn" onclick="setAction(this,'スマホを見た')">スマホを見た</button>
    <button class="select-btn" onclick="setAction(this,'読書した')">読書した</button>
    <button class="select-btn" onclick="setAction(this,'ストレッチした')">ストレッチした</button>
    <button class="select-btn" onclick="setAction(this,'何もしなかった')">何もしなかった</button>
  </div>

  <label>今日の気分</label>
  <div id="moodButtons">
    <button class="select-btn" onclick="setMood(this,'幸せ')">幸せ</button>
    <button class="select-btn" onclick="setMood(this,'疲れ')">疲れ</button>
    <button class="select-btn" onclick="setMood(this,'やる気満々')">やる気満々</button>
    <button class="select-btn" onclick="setMood(this,'悲しい')">悲しい</button>
  </div>

  <label>日記（任意）</label>
  <textarea id="diary" rows="4" placeholder="今日の出来事や感想を入力"></textarea>

  <div class="btn-row">
    <button id="saveBtn" onclick="saveData()">保存</button>
  </div>

  <!-- 表示文だけ「ホームに戻る」に変更、リンク先は履歴ページのまま -->
  <a class="back" href="history.html">← ホームに戻る</a>

  <script>
    const $ = id => document.getElementById(id);
    let records = JSON.parse(localStorage.getItem('sleepData') || '[]');

    function setTodayDate() {
      const today = new Date().toISOString().slice(0,10);
      if (!$('dateInput').value) $('dateInput').value = today;
    }
    setTodayDate();

    function calcSleepDurationVal() {
      const sleep = $('sleepTime').value;
      const wake = $('wakeTime').value;
      if (!sleep || !wake) return null;
      const s = new Date(`1970-01-01T${sleep}:00`);
      let w = new Date(`1970-01-01T${wake}:00`);
      if (w <= s) w.setDate(w.getDate() + 1);
      const hours = (w - s) / (1000 * 60 * 60);
      return Number(hours.toFixed(1));
    }

    function updateDurationText() {
      const v = calcSleepDurationVal();
      $('sleepDuration').textContent = v !== null ? `睡眠時間：${v}時間` : '睡眠時間：--時間';
      return v;
    }

    $('sleepTime').addEventListener('change', updateDurationText);
    $('wakeTime').addEventListener('change', updateDurationText);

    function activateButton(btn, groupId) {
      document.querySelectorAll(`#${groupId} .select-btn`).forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    let currentAction = '';
    let currentMood = '';

    function setAction(btn, a) {
      currentAction = a;
      activateButton(btn, 'actionButtons');
    }

    function setMood(btn, m) {
      currentMood = m;
      activateButton(btn, 'moodButtons');
    }

    const params = new URLSearchParams(window.location.search);
    const editIndex = params.has('edit') ? Number(params.get('edit')) : null;

    if (editIndex !== null && Number.isInteger(editIndex) && records[editIndex]) {
      const e = records[editIndex];
      $('dateInput').value = e.date || '';
      $('sleepTime').value = e.sleepTime || '';
      $('wakeTime').value = e.wakeTime || '';
      $('diary').value = e.diary || '';
      if (e.action) {
        currentAction = e.action;
        document.querySelectorAll('#actionButtons .select-btn').forEach(b => {
          if (b.textContent === e.action) b.classList.add('active');
        });
      }
      if (e.mood) {
        currentMood = e.mood;
        document.querySelectorAll('#moodButtons .select-btn').forEach(b => {
          if (b.textContent === e.mood) b.classList.add('active');
        });
      }
      updateDurationText();
      $('saveBtn').textContent = '更新して保存';
    }

    function saveData() {
      const date = $('dateInput').value;
      const sleepTime = $('sleepTime').value;
      const wakeTime = $('wakeTime').value;
      const diary = $('diary').value;
      const duration = calcSleepDurationVal();

      if (!date || !sleepTime || !wakeTime || duration === null) {
        alert('日付・就寝時間・起床時間を入力してください');
        return;
      }

      const entry = {
        date,
        sleepTime,
        wakeTime,
        duration,
        action: currentAction || '',
        mood: currentMood || '',
        diary: diary || ''
      };

      if (editIndex !== null && records[editIndex]) {
        records[editIndex] = entry;
      } else {
        records.push(entry);
      }

      localStorage.setItem('sleepData', JSON.stringify(records));
      alert(editIndex !== null ? '更新しました！' : '保存しました！');
      window.location.href = 'history.html';
    }
  </script>
</body>
</html>
