<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç¡çœ ã‚’è¨˜éŒ²ã™ã‚‹</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:"Hiragino Kaku Gothic ProN",sans-serif;background:#fff8e7;padding:22px}
    h1{background:orange;color:#fff;padding:12px;border-radius:12px;text-align:center}
    label{display:block;margin-top:12px;font-weight:700}
    input[type="time"], input[type="date"], textarea{
      width:100%;max-width:320px;padding:8px;
      border-radius:8px;border:1px solid #bbb;margin-top:6px
    }
    .btn-row{margin-top:12px}
    .select-btn{
      margin:6px;padding:8px 14px;border-radius:10px;border:none;
      background:#f0f0f0;cursor:pointer
    }
    .active{background:#ffcc80;border:2px solid orange;font-weight:700}
    #saveBtn{
      margin-top:20px;padding:12px 20px;border-radius:12px;
      background:orange;color:#fff;border:none;font-size:16px
    }
    a.back{display:block;margin-top:18px;color:#444;text-decoration:none}
  </style>
</head>
<body>
  <h1>ç¡çœ ã‚’è¨˜éŒ²ã™ã‚‹</h1>

  <label>æ—¥ä»˜</label>
  <input type="date" id="dateInput">

  <label>å¯ãŸæ™‚é–“ï¼ˆæ˜¨å¤œï¼‰</label>
  <input type="time" id="sleepTime">

  <label>èµ·ããŸæ™‚é–“ï¼ˆä»Šæœï¼‰</label>
  <input type="time" id="wakeTime">

  <p id="sleepDuration">ç¡çœ æ™‚é–“ï¼š--æ™‚é–“</p>

  <label>ç¡çœ å‰ã®è¡Œå‹•</label>
  <div id="actionButtons">
    <button class="select-btn" onclick="setAction(this,'ã‚¹ãƒãƒ›ã‚’è¦‹ãŸ')">ã‚¹ãƒãƒ›ã‚’è¦‹ãŸ</button>
    <button class="select-btn" onclick="setAction(this,'èª­æ›¸ã—ãŸ')">èª­æ›¸ã—ãŸ</button>
    <button class="select-btn" onclick="setAction(this,'ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ãŸ')">ã‚¹ãƒˆãƒ¬ãƒƒãƒã—ãŸ</button>
    <button class="select-btn" onclick="setAction(this,'ä½•ã‚‚ã—ãªã‹ã£ãŸ')">ä½•ã‚‚ã—ãªã‹ã£ãŸ</button>
  </div>

  <label>ä»Šæ—¥ã®æ°—åˆ†</label>
  <div id="moodButtons">
    <button class="select-btn" onclick="setMood(this,'å¹¸ã›')">ğŸ˜„</button>
    <button class="select-btn" onclick="setMood(this,'ç„¡')">ğŸ˜‘</button>
    <button class="select-btn" onclick="setMood(this,'çœ ã„')">ğŸ˜ª</button>
    <button class="select-btn" onclick="setMood(this,'ä½“èª¿ä¸è‰¯')">ğŸ¤§</button>
  </div>

  <label>æ—¥è¨˜ï¼ˆä»»æ„ï¼‰</label>
  <textarea id="diary" rows="4" placeholder="ä»Šæ—¥ã®æ„Ÿæƒ³ãªã©"></textarea>

  <div class="btn-row">
    <button id="saveBtn" onclick="saveData()">ä¿å­˜</button>
  </div>

  <a class="back" href="index.html">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>

  <script>
    const $ = id => document.getElementById(id);
    let records = JSON.parse(localStorage.getItem('sleepData') || '[]');

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆ
    function setToday() {
      const today = new Date().toISOString().substring(0,10);
      if (!$("dateInput").value) $("dateInput").value = today;
    }
    setToday();

    // ç¡çœ æ™‚é–“è¨ˆç®—
    function calcDuration() {
      const s = $("sleepTime").value;
      const w = $("wakeTime").value;
      if (!s || !w) return null;

      const start = new Date(`2020-01-01T${s}:00`);
      let end = new Date(`2020-01-01T${w}:00`);
      if (end <= start) end.setDate(end.getDate() + 1);

      const hours = (end - start) / (1000 * 60 * 60);
      return Math.round(hours * 10) / 10;
    }

    function updateDuration() {
      const v = calcDuration();
      $("sleepDuration").textContent = v ? `ç¡çœ æ™‚é–“ï¼š${v}æ™‚é–“` : "ç¡çœ æ™‚é–“ï¼š--æ™‚é–“";
    }

    $("sleepTime").addEventListener("change", updateDuration);
    $("wakeTime").addEventListener("change", updateDuration);

    let currentAction = "";
    let currentMood = "";

    function setAction(btn, value) {
      document.querySelectorAll("#actionButtons .select-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentAction = value;
    }

    function setMood(btn, value) {
      document.querySelectorAll("#moodButtons .select-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentMood = value;
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    const params = new URLSearchParams(location.search);
    const editIndex = params.has("edit") ? Number(params.get("edit")) : null;

    if (editIndex !== null && records[editIndex]) {
      const e = records[editIndex];
      $("dateInput").value = e.date || "";
      $("sleepTime").value = e.sleepTime || "";
      $("wakeTime").value = e.wakeTime || "";
      $("diary").value = e.diary || "";

      // ãƒœã‚¿ãƒ³åæ˜ 
      document.querySelectorAll("#actionButtons .select-btn").forEach(b => {
        if (b.textContent === e.action) b.classList.add("active");
      });
      currentAction = e.action;

      document.querySelectorAll("#moodButtons .select-btn").forEach(b => {
        if (b.textContent === e.mood) b.classList.add("active");
      });
      currentMood = e.mood;

      $("saveBtn").textContent = "æ›´æ–°ã—ã¦ä¿å­˜";
      updateDuration();
    }

    // -------------------------
    // è¡Œå‹•ã«å¿œã˜ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
    // -------------------------
    function makeAdvice(action) {
      if (!action) return "è¡Œå‹•ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";

      if (action.includes("ã‚¹ãƒãƒ›"))
        return "å¯ã‚‹å‰ã®ã‚¹ãƒãƒ›ã¯ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒˆã§çœ ã‚ŠãŒæµ…ããªã‚‹ã‚ˆã€‚ç”»é¢ã®æ˜ã‚‹ã•ã‚’è½ã¨ã™ã‹ã€æ—©ã‚ã«ã‚„ã‚ã‚‹ã®ãŒãŠã™ã™ã‚ï¼";

      if (action.includes("èª­æ›¸"))
        return "èª­æ›¸ã¯ãƒªãƒ©ãƒƒã‚¯ã‚¹ã«æœ€é©ï¼ç¡çœ ã®è³ªã‚¢ãƒƒãƒ—ã«ã¤ãªãŒã‚‹è‰¯ã„ç¿’æ…£ã§ã™ã€‚";

      if (action.includes("ã‚¹ãƒˆãƒ¬ãƒƒãƒ"))
        return "ã‚¹ãƒˆãƒ¬ãƒƒãƒã¯è¡€æµãŒè‰¯ããªã‚Šã€å¯ã¤ããŒã‚ˆããªã‚‹ã‚ˆã€‚ç¶šã‘ã¦ã¿ã¦ã­ï¼";

      if (action.includes("ä½•ã‚‚ã—ãªã‹ã£ãŸ"))
        return "ã‚†ã£ãã‚Šã™ã‚‹æ™‚é–“ã‚‚å¤§åˆ‡ã€‚æ·±å‘¼å¸ã‚’å°‘ã—ã ã‘å–ã‚Šå…¥ã‚Œã‚‹ã¨ã•ã‚‰ã«è‰¯ã„ã‚ˆã€‚";

      return "ãã®æ—¥ã®è¡Œå‹•ã«åˆã‚ã›ã¦ç„¡ç†ã›ãšç¶šã‘ã¦ã„ã“ã†ï¼";
    }

    // ä¿å­˜å‡¦ç†
    function saveData() {
      const entry = {
        date: $("dateInput").value,
        sleepTime: $("sleepTime").value,
        wakeTime: $("wakeTime").value,
        duration: calcDuration(),
        action: currentAction,
        mood: currentMood,
        diary: $("diary").value,
        advice: makeAdvice(currentAction)
      };

      if (!entry.date || !entry.sleepTime || !entry.wakeTime || entry.duration === null) {
        alert("æ—¥ä»˜ãƒ»æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      if (editIndex !== null && records[editIndex]) {
        records[editIndex] = entry;
      } else {
        records.push(entry);
      }

      localStorage.setItem("sleepData", JSON.stringify(records));

      // âœ… ä¿®æ­£æ¸ˆã¿ï¼šalert ã« HTML ã‚’å…¥ã‚Œãªã„
      alert(`ä¿å­˜ã—ã¾ã—ãŸï¼\n\nä»Šæ—¥ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼š\n${entry.advice}`);

      location.href = "history.html";
    }
  </script>
</body>
</html>
